<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HiChord Uploader</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --black: #0A0A0A;
            --white: #FAFAFA;
            --gray: #6B6B6B;
            --light-gray: #DADADA;
            --lighter-gray: #F2F2F2;
            --lightest-gray: #F8F8F8;
            --accent: #FF6B35;
            --accent-hover: #E85A28;
            --accent-light: #FFF4F0;
            --success: #10b981;
            --warning: #FFB800;
            --danger: #ef4444;
            --border-light: #E5E7EB;
            --border-medium: #D1D5DB;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Inter', 'SF Pro Display', 'Segoe UI', 'Helvetica Neue', Arial, sans-serif;
            background: var(--white);
            color: var(--black);
            line-height: 1.65;
            padding: 40px 20px;
            min-height: 100vh;
            font-size: 15px;
            font-weight: 400;
            letter-spacing: -0.011em;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        .container {
            max-width: 720px;
            width: 100%;
            margin: 0 auto;
        }

        .header {
            border-bottom: 1px solid var(--border-light);
            padding-bottom: 20px;
            margin-bottom: 40px;
        }

        .header h1 {
            font-size: 48px;
            font-weight: 600;
            letter-spacing: -1.2px;
            color: var(--black);
            text-transform: uppercase;
            margin-bottom: 8px;
        }

        .header p {
            font-size: 11px;
            color: var(--gray);
            text-transform: uppercase;
            letter-spacing: 1.8px;
            font-weight: 500;
        }

        .step {
            margin-bottom: 48px;
            opacity: 0.35;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }

        .step.active {
            opacity: 1;
            pointer-events: auto;
        }

        .step.complete {
            opacity: 0.6;
        }

        .step-header {
            font-size: 22px;
            font-weight: 600;
            margin-bottom: 24px;
            padding: 16px 20px;
            padding-left: 34px;
            letter-spacing: 0.5px;
            color: var(--black);
            border-left: 4px solid var(--light-gray);
            background: linear-gradient(90deg, var(--lightest-gray) 0%, transparent 100%);
            text-transform: uppercase;
            border-radius: 0 4px 4px 0;
            transition: all 0.3s ease;
        }

        .step.active .step-header {
            border-left-color: var(--accent);
            background: linear-gradient(90deg, var(--accent-light) 0%, transparent 100%);
        }

        .step.complete .step-header {
            border-left-color: var(--success);
            background: linear-gradient(90deg, #d1fae5 0%, transparent 100%);
        }

        .step-content {
            padding-left: 34px;
        }

        .instruction-box {
            border-left: 4px solid var(--accent);
            padding: 20px 24px;
            margin: 24px 0;
            background: var(--accent-light);
            border-radius: 0 6px 6px 0;
            border: 1px solid var(--border-light);
            border-left: 4px solid var(--accent);
        }

        .instruction-box.warning {
            border-left-color: var(--warning);
            background: #FFF9E6;
        }

        .instruction-box.success {
            border-left-color: var(--success);
            background: #d1fae5;
        }

        .instruction-box h3 {
            font-size: 12px;
            font-weight: 600;
            color: var(--black);
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 1.2px;
        }

        .instruction-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .instruction-list li {
            padding: 10px 0;
            color: var(--black);
            font-size: 14px;
            line-height: 1.6;
            border-bottom: 1px solid var(--border-light);
        }

        .instruction-list li:last-child {
            border-bottom: none;
        }

        .instruction-list li strong {
            font-weight: 600;
            color: var(--black);
        }

        .big-button {
            width: 100%;
            padding: 16px 24px;
            border: 2px solid var(--black);
            background: var(--black);
            color: var(--white);
            border-radius: 0;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.15s ease;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            font-family: inherit;
        }

        .big-button:hover:not(:disabled) {
            background: var(--white);
            color: var(--black);
            border-color: var(--black);
        }

        .big-button:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .big-button.primary {
            background: var(--accent);
            border-color: var(--accent);
            color: var(--white);
        }

        .big-button.primary:hover:not(:disabled) {
            background: var(--accent-hover);
            border-color: var(--accent-hover);
        }

        .big-button.success {
            background: var(--success);
            border-color: var(--success);
            color: var(--white);
        }

        .big-button.success:hover:not(:disabled) {
            background: #059669;
            border-color: #059669;
        }

        .big-button.warning {
            background: var(--warning);
            border-color: var(--warning);
            color: var(--black);
        }

        .big-button.warning:hover:not(:disabled) {
            background: #F5A500;
            border-color: #F5A500;
        }

        .progress-bar {
            width: 100%;
            height: 3px;
            background: var(--border-light);
            border-radius: 0;
            overflow: hidden;
            margin: 24px 0;
            display: none;
            border: 1px solid var(--border-light);
        }

        .progress-bar.show {
            display: block;
        }

        .progress-fill {
            height: 100%;
            background: var(--accent);
            width: 0%;
            transition: width 0.3s ease;
        }

        .status-message {
            padding: 16px 20px;
            margin: 20px 0;
            font-weight: 500;
            font-size: 13px;
            letter-spacing: 0.3px;
            display: none;
            border-left: 4px solid;
            border-radius: 0 4px 4px 0;
        }

        .status-message.show {
            display: block;
        }

        .status-message.success {
            background: #d1fae5;
            color: #065f46;
            border-left-color: var(--success);
        }

        .status-message.error {
            background: #fee2e2;
            color: #991b1b;
            border-left-color: var(--danger);
        }

        .status-message.info {
            background: var(--lightest-gray);
            color: var(--black);
            border-left-color: var(--gray);
        }

        .tab-selector {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 24px;
        }

        .tab {
            padding: 16px 24px;
            background: var(--white);
            border: 2px solid var(--border-light);
            text-align: center;
            cursor: pointer;
            font-weight: 600;
            font-size: 13px;
            color: var(--gray);
            transition: all 0.15s ease;
            text-transform: uppercase;
            letter-spacing: 1.2px;
        }

        .tab:hover {
            border-color: var(--border-medium);
        }

        .tab.active {
            background: var(--black);
            border-color: var(--black);
            color: var(--white);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        @media (max-width: 640px) {
            body {
                padding: 20px 16px;
            }

            .header h1 {
                font-size: 36px;
            }

            .step-content {
                padding-left: 20px;
            }

            .step-header {
                font-size: 18px;
                padding-left: 24px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>HiChord</h1>
            <p>Firmware Uploader // Web DFU</p>
        </div>

        <!-- STEP 1: Choose Path -->
        <div class="step active" id="step1">
            <div class="step-header">01 // Select Device Type</div>
            <div class="step-content">
                <div class="tab-selector">
                    <div class="tab active" onclick="selectDevice('fresh')">
                        Blank Daisy Seed
                    </div>
                    <div class="tab" onclick="selectDevice('hichord')">
                        Update HiChord
                    </div>
                </div>

                <div class="tab-content active" id="fresh-content">
                    <div class="instruction-box warning">
                        <h3>First-Time Setup Required</h3>
                        <p style="font-size: 14px; line-height: 1.6;">
                            Blank Daisy Seeds require bootloader installation followed by firmware upload. This process will install both automatically.
                        </p>
                    </div>
                    <button class="big-button warning" onclick="startBootloaderInstall()">
                        Install Bootloader + Firmware
                    </button>
                </div>

                <div class="tab-content" id="hichord-content">
                    <div class="instruction-box success">
                        <h3>Firmware Update</h3>
                        <p style="font-size: 14px; line-height: 1.6;">
                            For existing HiChord devices. Updates only the firmware using the Fn1+Fn2+Fn3 menu command.
                        </p>
                    </div>
                    <button class="big-button primary" onclick="startFirmwareUpdate()">
                        Update Firmware Only
                    </button>
                </div>
            </div>
        </div>

        <!-- STEP 2: Enter DFU Mode -->
        <div class="step" id="step2">
            <div class="step-header">02 // Enter DFU Mode</div>
            <div class="step-content">
                <div class="instruction-box" id="dfu-instructions">
                    <!-- Instructions will be inserted here -->
                </div>
                <button class="big-button primary" id="connectButton" onclick="connectAndUpload()">
                    Connect & Upload
                </button>
            </div>
        </div>

        <!-- STEP 3: Upload Progress -->
        <div class="step" id="step3">
            <div class="step-header">03 // Upload Progress</div>
            <div class="step-content">
                <div class="progress-bar show">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
                <div class="status-message show info" id="statusMessage">
                    Preparing upload...
                </div>
            </div>
        </div>

        <!-- STEP 4: Complete -->
        <div class="step" id="step4">
            <div class="step-header">04 // Complete</div>
            <div class="step-content">
                <div class="status-message show success" id="completeMessage">
                    <!-- Success message will be inserted here -->
                </div>
                <button class="big-button success" onclick="location.reload()">
                    Upload Another Device
                </button>
            </div>
        </div>
    </div>

    <script>
        // Binary file paths - relative to this HTML file
        const FIRMWARE_PATH = 'firmware/hichord_unified.bin';
        const BOOTLOADER_PATH = 'boot/dsy_bootloader_v6_2-extdfu-10ms.bin';

        // DFU Constants
        const DFU_DNLOAD = 0x01;
        const DFU_GETSTATUS = 0x03;
        const DFU_CLRSTATUS = 0x04;
        const DFU_ABORT = 0x06;

        // DFU States
        const dfuIDLE = 2;
        const dfuDNLOAD_SYNC = 3;
        const dfuDNBUSY = 4;
        const dfuDNLOAD_IDLE = 5;
        const dfuMANIFEST_SYNC = 6;
        const dfuMANIFEST = 7;
        const dfuMANIFEST_WAIT_RESET = 8;
        const dfuERROR = 10;

        // DfuSe Commands
        const DFUSE_SET_ADDRESS = 0x21;
        const DFUSE_ERASE_SECTOR = 0x41;

        // State
        let currentMode = null; // 'bootloader-only', 'firmware-after-bootloader', 'firmware-only'
        let device = null;
        let binary = null;
        let needsFirmwareAfterBootloader = false;

        // UI Functions
        function selectDevice(type) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));

            if (type === 'fresh') {
                event.target.classList.add('active');
                document.getElementById('fresh-content').classList.add('active');
            } else {
                event.target.closest('.tab').classList.add('active');
                document.getElementById('hichord-content').classList.add('active');
            }
        }

        function goToStep(stepNum) {
            document.querySelectorAll('.step').forEach((step, idx) => {
                step.classList.remove('active', 'complete');
                if (idx + 1 < stepNum) step.classList.add('complete');
                if (idx + 1 === stepNum) step.classList.add('active');
            });
        }

        async function startBootloaderInstall() {
            currentMode = 'bootloader-only';
            needsFirmwareAfterBootloader = true; // Will upload firmware after bootloader
            goToStep(2);

            try {
                binary = await loadBinary(BOOTLOADER_PATH);
            } catch (error) {
                updateStatus('❌ Failed to load bootloader file: ' + error.message, 'error');
                return;
            }

            document.getElementById('dfu-instructions').innerHTML = `
                <h3>Enter ROM Bootloader Mode</h3>
                <ul class="instruction-list">
                    <li><strong>Connect:</strong> Blank Daisy Seed via Micro USB to computer</li>
                    <li><strong>Press + Hold:</strong> BOOT button on Daisy Seed</li>
                    <li><strong>While Holding BOOT:</strong> Press and release RESET button</li>
                    <li><strong>Release:</strong> BOOT button</li>
                    <li><strong>LED Indicator:</strong> Solid light confirms ROM bootloader active</li>
                </ul>
                <p style="color: var(--gray); font-size: 13px; margin-top: 16px; font-style: italic;">This installs the Daisy bootloader, then automatically uploads HiChord firmware.</p>
            `;
        }

        async function startFirmwareUpdate() {
            currentMode = 'firmware-only';
            needsFirmwareAfterBootloader = false;
            goToStep(2);

            try {
                binary = await loadBinary(FIRMWARE_PATH);
            } catch (error) {
                updateStatus('❌ Failed to load firmware file: ' + error.message, 'error');
                return;
            }

            document.getElementById('dfu-instructions').innerHTML = `
                <h3>Enter DFU Mode via HiChord Menu</h3>
                <ul class="instruction-list">
                    <li><strong>Connect:</strong> HiChord via USB-C to computer</li>
                    <li><strong>Hold All Function Keys:</strong> Fn1 + Fn2 + Fn3 for 5 seconds</li>
                    <li><strong>LED Indicator:</strong> Pulsing light confirms DFU mode active</li>
                </ul>
                <p style="color: var(--gray); font-size: 13px; margin-top: 16px; font-style: italic;">Alternative: Press RESET button, then BOOT button within 2 seconds</p>
            `;
        }

        async function loadBinary(path) {
            updateStatus('Loading binary file...', 'info');
            const response = await fetch(path);
            if (!response.ok) throw new Error('File not found: ' + path);
            const data = await response.arrayBuffer();
            updateStatus(`Loaded ${(data.byteLength / 1024).toFixed(1)} KB`, 'success');
            return new Uint8Array(data);
        }

        async function connectAndUpload() {
            try {
                goToStep(3);
                updateStatus('Connecting to device...', 'info');

                device = await navigator.usb.requestDevice({
                    filters: [{ vendorId: 0x0483, productId: 0xdf11 }]
                });

                await device.open();
                if (!device.configuration) await device.selectConfiguration(1);

                const dfuInterface = device.configuration.interfaces.find(
                    iface => iface.alternates.some(alt => alt.interfaceClass === 0xFE && alt.interfaceSubclass === 0x01)
                );

                if (!dfuInterface) throw new Error('DFU interface not found');

                await device.claimInterface(dfuInterface.interfaceNumber);

                // Determine address and upload type based on mode
                let address, isQSPI;
                if (currentMode === 'bootloader-only') {
                    address = 0x08000000; // Internal flash
                    isQSPI = false;
                } else {
                    address = 0x90040000; // QSPI flash
                    isQSPI = true;
                }

                await uploadBinary(binary, address, isQSPI);

                // If we just installed bootloader on blank Daisy, now upload firmware
                if (needsFirmwareAfterBootloader) {
                    await handleFirmwareAfterBootloader();
                } else {
                    // Single upload complete
                    goToStep(4);
                    const msg = currentMode === 'firmware-only'
                        ? 'Firmware update complete. Your HiChord is ready to use.'
                        : 'Setup complete. Your HiChord is ready to use.';
                    document.getElementById('completeMessage').textContent = msg;
                }

            } catch (error) {
                updateStatus('❌ Error: ' + error.message, 'error');
                console.error(error);
            }
        }

        async function handleFirmwareAfterBootloader() {
            // Close the ROM bootloader connection
            try {
                await device.close();
            } catch (e) {
                console.log('Device close result:', e.message);
            }

            // Show instructions for entering Daisy bootloader
            goToStep(2);
            currentMode = 'firmware-after-bootloader';

            try {
                binary = await loadBinary(FIRMWARE_PATH);
            } catch (error) {
                updateStatus('❌ Failed to load firmware file: ' + error.message, 'error');
                return;
            }

            document.getElementById('dfu-instructions').innerHTML = `
                <h3>Enter Daisy Bootloader Mode</h3>
                <ul class="instruction-list">
                    <li><strong>Status:</strong> Bootloader installation complete</li>
                    <li><strong>Press:</strong> RESET button on Daisy Seed</li>
                    <li><strong>Then Press:</strong> BOOT button within 2 seconds</li>
                    <li><strong>LED Indicator:</strong> Pulsing light confirms Daisy bootloader active</li>
                </ul>
                <p style="color: var(--gray); font-size: 13px; margin-top: 16px; font-style: italic;">Now we'll upload the HiChord firmware to QSPI flash.</p>
            `;

            // Change button text
            document.getElementById('connectButton').textContent = 'Connect & Upload Firmware';
        }

        // Helper function to get DFU status
        async function getStatus() {
            const iface = device.configuration.interfaces[0].interfaceNumber;
            const result = await device.controlTransferIn({
                requestType: 'class',
                recipient: 'interface',
                request: DFU_GETSTATUS,
                value: 0,
                index: iface
            }, 6);

            return {
                status: result.data.getUint8(0),
                pollTimeout: result.data.getUint32(1, true) & 0xFFFFFF,
                state: result.data.getUint8(4)
            };
        }

        // Poll until a specific state is reached
        async function pollUntil(statePredicate) {
            let dfuStatus = await getStatus();

            while (!statePredicate(dfuStatus.state) && dfuStatus.state !== dfuERROR) {
                await new Promise(r => setTimeout(r, dfuStatus.pollTimeout));
                dfuStatus = await getStatus();
            }

            if (dfuStatus.state === dfuERROR) {
                throw new Error(`DFU Error: status=${dfuStatus.status}`);
            }

            return dfuStatus;
        }

        // Poll until device returns to IDLE state
        async function pollUntilIdle(idleState) {
            return await pollUntil(state => state === idleState);
        }

        // Send DfuSe command (SET_ADDRESS or ERASE_SECTOR)
        async function dfuseCommand(command, param, len) {
            const iface = device.configuration.interfaces[0].interfaceNumber;

            const payload = new ArrayBuffer(len + 1);
            const view = new DataView(payload);
            view.setUint8(0, command);
            if (len === 1) {
                view.setUint8(1, param);
            } else if (len === 4) {
                view.setUint32(1, param, true);
            }

            await device.controlTransferOut({
                requestType: 'class',
                recipient: 'interface',
                request: DFU_DNLOAD,
                value: 0,
                index: iface
            }, payload);

            // Wait for command to complete
            const status = await pollUntil(state => state !== dfuDNBUSY);
            if (status.status !== 0) {
                throw new Error(`DfuSe command failed: status=${status.status}`);
            }
        }

        // Erase flash sectors before programming (required for QSPI)
        async function eraseFlash(startAddr, length) {
            updateStatus('Erasing flash sectors...', 'info');

            // For QSPI: 4KB sectors
            const SECTOR_SIZE = 4096;
            const endAddr = startAddr + length;
            let addr = startAddr - (startAddr % SECTOR_SIZE); // Align to sector boundary

            const totalBytes = endAddr - addr;
            let bytesErased = 0;

            while (addr < endAddr) {
                await dfuseCommand(DFUSE_ERASE_SECTOR, addr, 4);
                addr += SECTOR_SIZE;
                bytesErased += SECTOR_SIZE;

                const progress = Math.min((bytesErased / totalBytes) * 30, 30); // 30% of progress bar
                document.getElementById('progressFill').style.width = progress + '%';
            }
        }

        async function uploadBinary(data, address, isQSPI) {
            const iface = device.configuration.interfaces[0].interfaceNumber;

            // Clear any errors
            await device.controlTransferOut({
                requestType: 'class',
                recipient: 'interface',
                request: DFU_CLRSTATUS,
                value: 0,
                index: iface
            }, new ArrayBuffer(0));

            await new Promise(r => setTimeout(r, 100));

            // For QSPI (firmware), we need to erase first
            if (isQSPI) {
                await eraseFlash(address, data.length);
            }

            const BLOCK_SIZE = 2048;
            let offset = 0;
            let currentAddr = address;

            updateStatus('Writing to flash memory...', 'info');

            while (offset < data.length) {
                const size = Math.min(BLOCK_SIZE, data.length - offset);
                const chunk = data.slice(offset, offset + size);

                // Set address before each chunk (DfuSe protocol requirement)
                await dfuseCommand(DFUSE_SET_ADDRESS, currentAddr, 4);

                // Download the chunk (always use blockNum=2 for DfuSe)
                await device.controlTransferOut({
                    requestType: 'class',
                    recipient: 'interface',
                    request: DFU_DNLOAD,
                    value: 2,
                    index: iface
                }, chunk.buffer);

                // CRITICAL: Poll until device finishes writing this block
                await pollUntilIdle(dfuDNLOAD_IDLE);

                offset += size;
                currentAddr += size;

                // Progress: 30-90% for download phase
                const downloadProgress = 30 + (offset / data.length) * 60;
                document.getElementById('progressFill').style.width = downloadProgress + '%';

                if (Math.floor(downloadProgress) % 10 === 0) {
                    updateStatus(`${Math.floor(downloadProgress)}% complete`, 'info');
                }
            }

            updateStatus('Finalizing upload...', 'info');
            document.getElementById('progressFill').style.width = '95%';

            // Manifestation: Set address back to start, then send empty block
            await dfuseCommand(DFUSE_SET_ADDRESS, address, 4);

            await device.controlTransferOut({
                requestType: 'class',
                recipient: 'interface',
                request: DFU_DNLOAD,
                value: 0,
                index: iface
            }, new ArrayBuffer(0));

            // Poll until manifestation
            try {
                await pollUntil(state => state === dfuMANIFEST);
            } catch (error) {
                // Manifestation may disconnect device, ignore errors
                console.log('Manifest poll result:', error.message);
            }

            document.getElementById('progressFill').style.width = '100%';
            updateStatus('Resetting device...', 'success');

            // Reset the device to boot new firmware
            try {
                await device.reset();
            } catch (error) {
                // Reset often causes disconnect, which is expected
                console.log('Reset result:', error.message);
            }

            await new Promise(r => setTimeout(r, 500));
        }

        function updateStatus(message, type) {
            const el = document.getElementById('statusMessage');
            el.textContent = message;
            el.className = 'status-message show ' + type;
        }

        window.addEventListener('load', () => {
            if (!navigator.usb) {
                alert('⚠️ WebUSB not supported. Please use Chrome or Edge browser.');
            }
        });
    </script>
</body>
</html>
